<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Catálogo de Productos</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
    body {
        font-family: Arial, sans-serif;
        background: #f2f2f2;
        padding: 20px;
        margin: 0;
    }

    h2 {
        text-align: center;
        color: #00416A;
        margin-bottom: 20px;
    }

    #buscadorBox {
        position: relative;
        max-width: 600px;
        margin: auto;
    }

    #buscar {
        width: 100%;
        padding: 12px;
        font-size: 16px;
        border-radius: 6px;
        border: 1px solid #bbb;
    }

    #sugerencias {
        position: absolute;
        top: calc(100% + 4px);
        left: 0;
        width: 100%;
        background: white;
        border: 1px solid #ccc;
        border-radius: 6px;
        display: none;
        max-height: 250px;
        overflow-y: auto;
        z-index: 999;
        box-shadow: 0 2px 6px rgba(0,0,0,.2);
    }

    #sugerencias div {
        padding: 10px;
        border-bottom: 1px solid #eee;
        cursor: pointer;
    }

    #sugerencias div:hover {
        background: #f0f0f0;
    }

    #detalleProducto {
        display: none;
        background: white;
        max-width: 800px;
        margin: 20px auto;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 6px rgba(0,0,0,.2);
    }

    .switch {
        position: relative;
        width: 50px;
        height: 24px;
        display: inline-block;
    }
    .switch input {
        display: none;
    }
    .slider {
        position: absolute;
        cursor: pointer;
        background: #ccc;
        border-radius: 24px;
        top: 0; left: 0; right: 0; bottom: 0;
        transition: .3s;
    }
    .slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background: white;
        border-radius: 50%;
        transition: .3s;
    }
    input:checked + .slider {
        background: #00416A;
    }
    input:checked + .slider:before {
        transform: translateX(26px);
    }

    button {
        background: #00416A;
        color: white;
        padding: 10px 16px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        margin-top: 10px;
    }
</style>
</head>

<body>

<h2>Catálogo de Productos</h2>

<div id="buscadorBox">
    <input id="buscar" placeholder="Buscar por descripción...">
    <div id="sugerencias"></div>
</div>

<div id="detalleProducto">
    <h3 id="tituloProd"></h3>

    <p><b>Código:</b> <span id="codigoProd"></span></p>
    <p><b>Descripción:</b> <span id="descProd"></span></p>

    <p><b>Activo:</b>
        <label class="switch">
            <input type="checkbox" id="switchActivo">
            <span class="slider"></span>
        </label>
    </p>

    <p><b>Proveedor:</b><br>
        <input id="proveedorInput" placeholder="Ingresa proveedor..." style="width:100%;padding:8px;">
    </p>

    <p><b>Departamento:</b> <span id="deptoProd"></span></p>
    <p><b>Marca:</b> <span id="marcaProd"></span></p>
    <p><b>Precio público:</b> <span id="pubProd"></span></p>
    <p><b>Mayoreo:</b> <span id="mayProd"></span></p>
    <p><b>Medio mayoreo:</b> <span id="medioProd"></span></p>
    <p><b>Costo sin impuesto:</b> <span id="costoProd"></span></p>
    <p><b>IVA:</b> <span id="ivaProd"></span></p>
    <p><b>IEPS:</b> <span id="iepsProd"></span></p>
    <p><b>Caja:</b> <span id="cajaProd"></span></p>

    <button onclick="guardarCambios()">Guardar Cambios</button>
    <br><br>
    <button onclick="cerrarDetalle()">Cerrar</button>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getFirestore, collection, getDocs, doc, updateDoc }
from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
  authDomain: "inventariopv-643f1.firebaseapp.com",
  projectId: "inventariopv-643f1",
  storageBucket: "inventariopv-643f1.firebasestorage.app",
  messagingSenderId: "96242533231",
  appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let productos = [];
let productoActual = null;

/* Cargar productos */
async function cargarProductos() {
    const snap = await getDocs(collection(db, "productos"));
    productos = [];
    snap.forEach(d => productos.push({ id: d.id, ...d.data() }));
}
cargarProductos();

/* Buscador */
const input = document.getElementById("buscar");
const sug = document.getElementById("sugerencias");

input.addEventListener("input", () => {
    const t = input.value.toLowerCase().trim();
    sug.innerHTML = "";
    sug.style.display = "none";

    if (!t) return;

    const palabras = t.split(" ").filter(x => x.length > 0);

    const filtrado = productos.filter(p => {
        const concepto = String(p.concepto ?? "").toLowerCase();
        return palabras.every(palabra => concepto.includes(palabra));
    });

    if (filtrado.length === 0) return;

    sug.style.display = "block";

    filtrado.slice(0, 10).forEach(p => {
        const div = document.createElement("div");
        div.innerHTML = `<b>${p.codigoBarra ?? ""}</b> - ${p.concepto}`;
        div.onclick = () => seleccionarProducto(p);
        sug.appendChild(div);
    });
});

/* Seleccionar producto */
function seleccionarProducto(p) {
    input.value = `${p.codigoBarra} | ${p.concepto}`;
    sug.style.display = "none";
    abrirProducto(p);
}

/* Abrir detalle */
function abrirProducto(p) {

    productoActual = p;

    document.getElementById("detalleProducto").style.display = "block";

    document.getElementById("tituloProd").innerText = p.concepto ?? "";
    document.getElementById("codigoProd").innerText = p.codigoBarra ?? "";
    document.getElementById("descProd").innerText = p.concepto ?? "";

    document.getElementById("switchActivo").checked = p.activo === true;

    document.getElementById("proveedorInput").value = p.proveedor ?? "";

    document.getElementById("deptoProd").innerText = p.departamento ?? "";
    document.getElementById("marcaProd").innerText = p.marca ?? "";
    document.getElementById("pubProd").innerText = p.precioPublico ?? "";
    document.getElementById("mayProd").innerText = p.mayoreo ?? "";
    document.getElementById("medioProd").innerText = p.medioMayoreo ?? "";
    document.getElementById("costoProd").innerText = p.costoSinImpuesto ?? "";
    document.getElementById("ivaProd").innerText = p.ivaTasa ?? "";
    document.getElementById("iepsProd").innerText = p.iepsTasa ?? "";
    document.getElementById("cajaProd").innerText = p.cantidadPorCaja ?? "";
}

/* Guardar cambios */
async function guardarCambios() {

    if (!productoActual) return;

    const activoNuevo = document.getElementById("switchActivo").checked;
    const proveedorNuevo = document.getElementById("proveedorInput").value.trim();

    await updateDoc(doc(db, "productos", productoActual.id), {
        activo: activoNuevo,
        proveedor: proveedorNuevo
    });

    alert("Cambios guardados correctamente.");
}

/* Cerrar */
function cerrarDetalle() {
    document.getElementById("detalleProducto").style.display = "none";
}

window.seleccionarProducto = seleccionarProducto;
window.guardarCambios = guardarCambios;
window.cerrarDetalle = cerrarDetalle;

</script>

</body>
</html>
