<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Catálogo de Productos</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
    body {
        font-family: Arial, sans-serif;
        background: #f2f2f2;
        margin: 0;
        padding: 20px;
    }
    h2 {
        text-align: center;
        color: #00416A;
    }
    #listaProductos .card {
        background: white;
        margin: 10px 0;
        padding: 15px;
        border-radius: 8px;
        cursor: pointer;
        border-left: 6px solid #00416A;
    }
    #detalleProducto {
        background: white;
        padding: 20px;
        border-radius: 10px;
        margin-top: 15px;
        display: none;
    }
    .linea-box {
        background: #e8f2f8;
        padding: 10px;
        margin: 5px 0;
        border-radius: 6px;
    }
    button {
        background: #00416A;
        color: white;
        border: none;
        padding: 10px 16px;
        border-radius: 6px;
        cursor: pointer;
        margin-top: 10px;
    }
    input {
        width: 100%;
        padding: 10px;
        margin: 8px 0;
        border-radius: 6px;
        border: 1px solid #ccc;
    }
</style>
</head>

<body>

<h2>Catálogo de Productos</h2>

<input id="buscar" placeholder="Buscar por código o descripción...">

<div id="listaProductos"></div>

<div id="detalleProducto">
    <h3 id="tituloProd"></h3>
    <p><b>Código:</b> <span id="codigoProd"></span></p>
    <p><b>Descripción:</b> <span id="descProd"></span></p>

    <h3>Líneas registradas</h3>
    <div id="lineasBox"></div>

    <h3>Agregar nueva línea</h3>
    <input id="nuevaLinea" placeholder="Nombre de la línea">
    <input id="infoExtra" placeholder="Información extra">
    <button onclick="agregarLinea()">Guardar Línea</button>

    <br><br>
    <button onclick="cerrarDetalle()">Cerrar</button>
</div>

<!-- Firebase -->
<script type="module">
import { 
    initializeApp 
} from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";

import {
    getFirestore, collection, getDocs, doc,
    addDoc
} from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

/* =======================================================
   CONFIGURA TUS CREDENCIALES AQUI
========================================================= */
const firebaseConfig = {
    apiKey: "TU_API_KEY",
    authDomain: "TU_AUTH_DOMAIN",
    projectId: "TU_PROJECT_ID",
    storageBucket: "TU_BUCKET",
    messagingSenderId: "ID",
    appId: "ID"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let productos = [];
let productoActual = null;

/* =======================================================
   CARGAR TODOS LOS PRODUCTOS
========================================================= */
async function cargarProductos() {
    const ref = collection(db, "productos");
    const snap = await getDocs(ref);

    productos = [];
    snap.forEach(d => {
        productos.push({ id: d.id, ...d.data() });
    });

    mostrarLista(productos);
}

/* =======================================================
   MOSTRAR LISTA
========================================================= */
function mostrarLista(arr) {
    const cont = document.getElementById("listaProductos");
    cont.innerHTML = "";

    arr.forEach(p => {
        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `
            <b>${p.codigoBarra}</b><br>
            ${p.concepto}
        `;
        div.onclick = () => abrirProducto(p);
        cont.appendChild(div);
    });
}

/* =======================================================
   BUSCADOR
========================================================= */
document.getElementById("buscar").addEventListener("input", () => {
    const t = document.getElementById("buscar").value.toLowerCase();
    const filtrado = productos.filter(p =>
        p.codigoBarra.toLowerCase().includes(t) ||
        p.concepto.toLowerCase().includes(t)
    );
    mostrarLista(filtrado);
});

/* =======================================================
   ABRIR PRODUCTO
========================================================= */
async function abrirProducto(p) {
    productoActual = p;

    document.getElementById("detalleProducto").style.display = "block";
    document.getElementById("tituloProd").innerText = p.concepto;
    document.getElementById("codigoProd").innerText = p.codigoBarra;
    document.getElementById("descProd").innerText = p.concepto;

    cargarLineas(p.id);
}

/* =======================================================
   CARGAR LÍNEAS (subcolección)
========================================================= */
async function cargarLineas(id) {
    const ref = collection(db, "productos", id, "lineas");
    const snap = await getDocs(ref);

    const cont = document.getElementById("lineasBox");
    cont.innerHTML = "";

    snap.forEach(d => {
        const data = d.data();
        const div = document.createElement("div");
        div.className = "linea-box";
        div.innerHTML = `
            <b>${data.nombre}</b><br>
            ${data.extra ?? ""}
        `;
        cont.appendChild(div);
    });
}

/* =======================================================
   AGREGAR NUEVA LÍNEA
========================================================= */
async function agregarLinea() {
    if (!productoActual) return;

    const nombre = document.getElementById("nuevaLinea").value.trim();
    const extra = document.getElementById("infoExtra").value.trim();

    if (!nombre) {
        alert("Ingresa un nombre de línea");
        return;
    }

    await addDoc(collection(db, "productos", productoActual.id, "lineas"), {
        nombre,
        extra,
        fecha: new Date().toISOString()
    });

    document.getElementById("nuevaLinea").value = "";
    document.getElementById("infoExtra").value = "";

    cargarLineas(productoActual.id);
}

/* =======================================================
   CERRAR DETALLE
========================================================= */
function cerrarDetalle() {
    document.getElementById("detalleProducto").style.display = "none";
}

cargarProductos();

</script>

</body>
</html>
